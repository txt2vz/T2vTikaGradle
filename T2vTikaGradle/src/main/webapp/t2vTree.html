<!DOCTYPE html>
<html lang="en">

<head>
<!-- Bootstrap CSS Toolkit styles -->

<link rel="stylesheet"
	href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
<!--  	href="http://blueimp.github.com/cdn/css/bootstrap.min.css"> -->
<!-- Generic page styles -->
<link rel="stylesheet" href="css/style.css">
<!-- Bootstrap styles for responsive website layout, supporting different screen sizes -->
<link
	href="http://getbootstrap.com/2.3.2/assets/css/bootstrap-responsive.css"
	rel="stylesheet">
<!-- Bootstrap CSS fixes for IE6 -->
<!--[if lt IE 7]><link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap-ie6.min.css"><![endif]-->
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="css/jquery.fileupload-ui.css">

<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>t2vd3</title>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="js/vendor/jquery.ui.widget.js"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="js/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="js/jquery.fileupload.js"></script>
<script src="http://malsup.github.com/jquery.form.js"></script>

	
	<script src="http://d3js.org/d3.v3.min.js"></script>





<style type="text/css">
.node {
	cursor: pointer;
}

.overlay {
	background-color: #FFF;
}

.node circle {
	fill: #fff;
	stroke: steelblue;
	stroke-width: 1.5px;
}

.node text {
	font-size: 10px;
	font-family: sans-serif;
}

.link {
	fill: none;
	stroke: #ccc;
	stroke-width: 1.5px;
}
</style>



</head>
<body>
	<div class="container">
		<em style="font-size: 48px"><b> <span
				style="color: blueviolet">t</span><span style="color: cyan">xt</span><span
				style="color: magenta">2</span><span style="color: cyan">vz</span></b></em>:
		<span style="font-family: arial; font-size: 17px;">Visualize
			your Documents.</span>

		<nav class="navbar navbar-inverse" role="navigation">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">

				<a class="navbar-brand" href="index.html">Viz</a> <a
					class="navbar-brand" href="info.html">Information</a>
			</div>
		</nav>


		<div id='content' class='row-fluid'>
			<div class='span10 main active'>


				<script>
					//	var jl = "{"links":[{"source":"laurie", "target":"hirsch, "rank":0}]}";
					var jl = {};
					jl.links = [ {
						'source' : 'txt2vz',
						'target' : 'by',
						'rank' : 7
					}, {
						'source' : 'laurie',
						'target' : 'by',
						'rank' : 8
					}, {
						'source' : 'txt2vz',
						'target' : 'document',
						'rank' : 0
					}, {
						'source' : 'analysis',
						'target' : 'visualization',
						'rank' : 2
					}, {
						'source' : 'summary',
						'target' : 'visualization',
						'rank' : 3
					}, {
						'source' : 'concept',
						'target' : 'visualization',
						'rank' : 4
					}, {
						'source' : 'document',
						'target' : 'mind',
						'rank' : 7
					}, {
						'source' : 'mind',
						'target' : 'map',
						'rank' : 7
					}, {
						'source' : 'document',
						'target' : 'visualization',
						'rank' : 1
					}, {
						'source' : 'laurie',
						'target' : 'hirsch',
						'rank' : 2
					}

					];
					//drawLinks(jl);
				</script>
			</div>

			<div class='span2 sidebar'>
				<h3>Select Source</h3>
				Select a file to visualize (e.g. pdf, docx, xml, ppt, txt, html
				etc.) You can also drag and drop your file here.
				<!-- The fileinput-button span is used to style the file input field as button -->
				<span class="btn btn-success fileinput-button"> <i
					class="icon-plus icon-white"></i> <span>Select File</span> <!-- The file input field used as target for the file upload widget -->
					<input id="fileupload" type="file" name="files[]" multiple>
				</span> <br> <br />
				<!-- The global progress bar -->
				<div id="progress"
					class="progress progress-success progress-striped">
					<div class="bar"></div>
				</div>
				<!-- The container for the uploaded files -->
				<div id="files"></div>
				<br>
				<p>Type in a Twitter query or Hashtag:</p>

				<input type="text" name="twitQ" id="twitQ" size=40
					value="word cloud"> <input type="button"
					value="viz Twitter" onclick="lookupTwit(twitQ.value)"> <br />
				<br /> Type in a URL <input type="text" id="url2"
					value="https://en.wikipedia.org/wiki/Tag_cloud" size=40>

				<button onclick="lookupURL(url2.value)">viz URL</button>

				<br /> <br />
				<p>Paste in text</p>

				<textarea id="txta1" COLS="30" ROWS="5"
					placeholder="Type or paste text here"> </textarea>
				<input type="button" value="viz text" onclick="pasted(txta1.value)">

				<br></br>	
				<div id="tree-container"></div>
		
				

				<script>
					/*jslint unparam: true *//*global window, $ */
					var viewerWidth = $(document).width();
					var viewerHeight = $(document).height();
					
					console.log("viewhieght " + viewerHeight + " viewWidth " + viewerWidth);
					
					$(function() {
						//'use strict';
						$('#fileupload').fileupload(
								{
									url : "uploadservice",//url,
									dataType : 'text',
									done : function(e, data) {
										//	alert('data is ' + data.result.files);

										//   $.each(data.result.files, function (index, file) {
										// alert ('f ' + data.result.files.name);
										// $('<p/>').text(file.name).appendTo('#files');
										//    });
										//alert ("tyring");
										drawLinks(data.result);
									},
									progressall : function(e, data) {
										var progress = parseInt(data.loaded
												/ data.total * 100, 10);
										$('#progress .bar').css('width',
												progress + '%');
									}
								});
					});
				</script>

				<script>
					function pasted(s) {
						s = s.replace(/%/g, '');

						$.ajax({
							type : "POST",
							url : "pastedText.groovy",
							cache : false,
							data : "s=" + s,
							success : function(data, textStatus, jqXHR) {
								//drawLinks(data);
								console.log("data back from draw " + data);
								drawDendrogram(data, viewerWidth, viewerHeight);
							},

						});
					}
				</script>

				<script type="text/javascript">
					function lookupURL(url) {
						$.ajax({
							type : "POST",
							url : "url.groovy",
							cache : false,
							data : "u=" + url,
							success : function(data, textStatus, jqXHR) {
								drawLinks(data);
							},
							error : function(jqXHR, textStatus, errorThrown) {
								alert("error " + textStatus);
							}
						});
					}
				</script>

				<script type="text/javascript">
					function lookupTwit(twq) {

						$.ajax({
							type : "POST",
							//url : "twitservice",
							url : "twitter.groovy",
							cache : false,
							data : "q=" + twq,
							success : function(data, textStatus, jqXHR) {
								//alert("in twit jq " + data);
								drawLinks(data);
							},
							error : function(jqXHR, textStatus, errorThrown) {
								alert("error " + textStatus);
							}
						});
					}
				</script>
				
						<script>
				function drawDendrogram(json, height, width) {

					// $("#tree-container").height(); //$(document).height();
					console.log("in drawDendrongram");
					
					// size of the diagram
					var viewerWidth = width;//$(document).width();
					var viewerHeight = height; //$(document).height();
					console.log("in draw tree viewhieght " + viewerHeight + " viewWidth " + viewerWidth);

					var tree = d3.layout.tree().size([ viewerHeight, viewerWidth ]);
					
					d3.select("svg").remove();
					//var jsonFile = e.target.result;
					var treeData = JSON.parse(json);

					var fillColour = "mediumslateblue";
					// Calculate total nodes, max label length
					var totalNodes = 0;
					var maxLabelLength = 20;

					var panSpeed = 200;
					var panBoundary = 20; // Within 20px from edges will pan when dragging.
					// Misc. variables
					var i = 0;
					var duration = 750;
					var root;



					// define a d3 diagonal projection for use by the node paths later on.
					var diagonal = d3.svg.diagonal().projection(function(d) {
						return [ d.y, d.x ];
					});

					// TODO: Pan function, can be better implemented.
					function pan(domNode, direction) {
						var speed = panSpeed;
						if (panTimer) {
							clearTimeout(panTimer);
							translateCoords = d3.transform(svgGroup.attr("transform"));
							if (direction == 'left' || direction == 'right') {
								translateX = direction == 'left' ? translateCoords.translate[0]
										+ speed : translateCoords.translate[0] - speed;
								translateY = translateCoords.translate[1];
							} else if (direction == 'up' || direction == 'down') {
								translateX = translateCoords.translate[0];
								translateY = direction == 'up' ? translateCoords.translate[1]
										+ speed : translateCoords.translate[1] - speed;
							}
							scaleX = translateCoords.scale[0];
							scaleY = translateCoords.scale[1];
							scale = zoomListener.scale();
							svgGroup.transition().attr(
									"transform",
									"translate(" + translateX + "," + translateY + ")scale("
											+ scale + ")");
							d3.select(domNode).select('g.node').attr("transform",
									"translate(" + translateX + "," + translateY + ")");
							zoomListener.scale(zoomListener.scale());
							zoomListener.translate([ translateX, translateY ]);
							panTimer = setTimeout(function() {
								pan(domNode, speed, direction);
							}, 50);
						}
					}

					// Define the zoom function for the zoomable tree
					function zoom() {
						svgGroup.attr("transform", "translate(" + d3.event.translate
								+ ")scale(" + d3.event.scale + ")");
					}

					// define the zoomListener which calls the zoom function on the "zoom" event
					// constrained within the scaleExtents
					var zoomListener = d3.behavior.zoom().scaleExtent([ 0.1, 3 ]).on("zoom",
							zoom);

					// define the baseSvg, attaching a class for styling and the zoomListener
					var baseSvg = d3.select("#tree-container").append("svg").attr("width",
							viewerWidth).attr("height", viewerHeight).attr("class", "overlay")
							.call(zoomListener);

					// Helper functions for collapsing and expanding nodes.
					function collapse(d) {
						if (d.children) {
							d._children = d.children;
							d._children.forEach(collapse);
							d.children = null;
						}
					}

					function expand(d) {
						if (d._children) {
							d.children = d._children;
							d.children.forEach(expand);
							d._children = null;
						}
					}

					var overCircle = function(d) {
						selectedNode = d;
						updateTempConnector();
					};
					var outCircle = function(d) {
						selectedNode = null;
						updateTempConnector();
					};

					// Function to center node when clicked/dropped so node doesn't get lost
					// when collapsing/moving with large amount of children.
					function centerNode(source) {
						scale = zoomListener.scale();
						x = -source.y0;
						y = -source.x0;
						x = x * scale + viewerWidth / 2;
						y = y * scale + viewerHeight / 2;
						d3.select('g').transition().duration(duration).attr("transform",
								"translate(" + x + "," + y + ")scale(" + scale + ")");
						zoomListener.scale(scale);
						zoomListener.translate([ x, y ]);
					}

					// Toggle children function
					function toggleChildren(d) {
						if (d.children) {
							d._children = d.children;
							d.children = null;
						} else if (d._children) {
							d.children = d._children;
							d._children = null;
						}
						return d;
					}

					// Toggle children on click.
					function click(d) {
						// if (d3.event.defaultPrevented)
						// return; // click suppressed
						d = toggleChildren(d);
						update(d);
						// centerNode(d);
					}

					function update(source) {

						// collapse all children so click will only open one level.
						// not applied initially if fully expanded selected
						if (oneLevel) {
							if (source.children)
								source.children.forEach(function(child) {
									collapse(child);
								});
						}
						oneLevel = true;

						console.log("in update");
						// Compute the new height, function counts total children of root node
						// and sets tree height accordingly.
						// This prevents the layout looking squashed when new nodes are made
						// visible or looking sparse when nodes are removed
						// This makes the layout more consistent.
						var levelWidth = [ 1 ];
						var childCount = function(level, n) {

							if (n.children && n.children.length > 0) {
								if (levelWidth.length <= level + 1)
									levelWidth.push(0);

								levelWidth[level + 1] += n.children.length;
								n.children.forEach(function(d) {
									childCount(level + 1, d);
								});
							}
						};
						childCount(0, root);
						var newHeight = d3.max(levelWidth) * 80;// 25; // 25 pixels per line
						tree = tree.size([ newHeight, viewerWidth ]);

						// Compute the new tree layout.
						var nodes = tree.nodes(root).reverse(), links = tree.links(nodes);

						// Set widths between levels based on maxLabelLength.
						nodes.forEach(function(d) {
							d.y = (d.depth * (maxLabelLength * 10)); // maxLabelLength * 10px
							// alternatively to keep a fixed scale one can set a fixed depth per
							// level
							// Normalize for fixed-depth by commenting out below line
							// d.y = (d.depth * 500); //500px per level.
						});

						// Update the nodes…
						node = svgGroup.selectAll("g.node").data(nodes, function(d) {
							return d.id || (d.id = ++i);
						});

						// Enter any new nodes at the parent's previous position.
						var nodeEnter = node.enter().append("g")
						// .call(dragListener)
						.attr("class", "node").attr("transform", function(d) {
							return "translate(" + source.y0 + "," + source.x0 + ")";
						}).on('click', click);

						nodeEnter.append("circle").attr('class', 'nodeCircle').attr("r", 0)
								.style("fill", function(d) {
									return d._children ? fillColour : "#fff";
								});

						node.selectAll("text").remove();

						// NodeID
						node.append("text").attr("dy", ".35em").attr("text-anchor", "middle")
								.text(function(d) {
									return d.name;
								});

						node.append("svg:title").text(function(d) {
							return d.attributes;
						});
						

						// Transition nodes to their new position.
						var nodeUpdate = node.transition().duration(duration).attr("transform",
								function(d) {
									return "translate(" + d.y + "," + d.x + ")";
								});

						nodeUpdate.select("circle").attr("r", 15).style("fill", function(d) {
							return d._children ? fillColour : "#fff";
						});

						// Fade the text in
						nodeUpdate.select("text").style("fill-opacity", 1);

						// Transition exiting nodes to the parent's new position.
						var nodeExit = node.exit().transition().duration(duration).attr(
								"transform", function(d) {
									return "translate(" + source.y + "," + source.x + ")";
								}).remove();

						nodeExit.select("circle").attr("r", 0);

						nodeExit.select("text").style("fill-opacity", 0);

						// Update the links…
						var link = svgGroup.selectAll("path.link").data(links, function(d) {
							return d.target.id;
						});

						// Enter any new links at the parent's previous position.
						link.enter().insert("path", "g").attr("class", "link").attr("d",
								function(d) {
									var o = {
										x : source.x0,
										y : source.y0
									};
									return diagonal({
										source : o,
										target : o
									});
								});

						// Transition links to their new position.
						link.transition().duration(duration).attr("d", diagonal);

						// Transition exiting nodes to the parent's new position.
						link.exit().transition().duration(duration).attr("d", function(d) {
							var o = {
								x : source.x,
								y : source.y
							};
							return diagonal({
								source : o,
								target : o
							});
						}).remove();

						// Stash the old positions for transition.
						nodes.forEach(function(d) {
							d.x0 = d.x;
							d.y0 = d.y;
						});
					}

					// Append a group which holds all nodes and which the zoom Listener can act
					// upon.
					var svgGroup = baseSvg.append("g");

					// Define the root
					root = treeData;
					root.x0 = 200;// (viewerHeight) / 4;
					root.y0 = 40;

					scale = zoomListener.scale();
					x = root.y0;
					y = root.x0;

					d3.select('g').transition().duration(duration).attr("transform",
							"translate(" + x + "," + y + ")scale(" + scale + ")");
					zoomListener.scale(scale);
					zoomListener.translate([ x, y ]);

					var oneLevel = $('input[name=type]:checked', '#expanded').val() == "oneLevel";

					console.log("oneLevel: " + oneLevel);

					// Collapse all children of roots children before rendering.
					if (oneLevel)
						root.children.forEach(function(child) {
							collapse(child);
						});

					// Layout the tree initially and center on the root node.
					update(root);
					// centerNode(root);
				};

				</script>

			</div>
		</div>

	</div>
</body>
</html>